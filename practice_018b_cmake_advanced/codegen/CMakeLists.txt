# ╔══════════════════════════════════════════════════════════════════════════════╗
# ║  Phase 5: Custom Commands & Code Generation                                ║
# ╚══════════════════════════════════════════════════════════════════════════════╝
#
# Demonstrates add_custom_command() to generate C++ source at build time.
#
# The pipeline:
#   1. data.txt → embed_file.cmake → embedded_data.h (generated at build time)
#   2. codegen_demo.cpp #includes embedded_data.h and prints the contents
#
# Key concepts:
#   - add_custom_command(OUTPUT ...): declares a file that is GENERATED by a command.
#     CMake tracks this file as a dependency — if data.txt changes, the header
#     is regenerated, and codegen_demo is recompiled.
#
#   - The DEPENDS keyword creates the dependency chain:
#     data.txt → embed_file.cmake → embedded_data.h → codegen_demo.cpp → codegen_demo.exe
#
#   - COMMENT: printed during build to show what's happening
#
#   - VERBATIM: ensures arguments are passed correctly across platforms
#
# Docs: https://cmake.org/cmake/help/latest/command/add_custom_command.html


# ─── Define paths ────────────────────────────────────────────────────────────

set(EMBED_SCRIPT "${CMAKE_CURRENT_SOURCE_DIR}/embed_file.cmake")
set(INPUT_FILE   "${CMAKE_CURRENT_SOURCE_DIR}/data.txt")
set(OUTPUT_FILE  "${CMAKE_CURRENT_BINARY_DIR}/embedded_data.h")

# ─── Custom command: generate the header ─────────────────────────────────────
#
# add_custom_command(OUTPUT <file>):
#   Tells CMake: "this file does not exist yet, but here's how to create it."
#   Any target that depends on OUTPUT_FILE (via source files or explicit deps)
#   will trigger this command before compilation.
#
# ${CMAKE_COMMAND} is the path to cmake itself — ensures the correct cmake
# version runs the script, even if multiple cmake versions are installed.
#
# -P flag runs a cmake script in "script mode" (no project, no targets).
# -D flags pass variables to the script.

add_custom_command(
    OUTPUT "${OUTPUT_FILE}"
    COMMAND ${CMAKE_COMMAND}
        -DINPUT_FILE=${INPUT_FILE}
        -DOUTPUT_FILE=${OUTPUT_FILE}
        -DVAR_NAME=embedded_data
        -P ${EMBED_SCRIPT}
    DEPENDS
        "${INPUT_FILE}"
        "${EMBED_SCRIPT}"
    COMMENT "Embedding data.txt as C++ string literal..."
    VERBATIM
)

# ─── Executable that uses the generated header ───────────────────────────────
#
# By listing OUTPUT_FILE in the sources, CMake knows codegen_demo depends on it.
# This triggers the custom command above before compiling codegen_demo.cpp.

add_executable(codegen_demo
    codegen_demo.cpp
    "${OUTPUT_FILE}"    # Generated file — triggers the custom command
)

# The generated header lives in CMAKE_CURRENT_BINARY_DIR
target_include_directories(codegen_demo PRIVATE "${CMAKE_CURRENT_BINARY_DIR}")

target_compile_features(codegen_demo PRIVATE cxx_std_17)
